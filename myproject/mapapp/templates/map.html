{% extends "base.html" %}
{% load static %}

{% block title %}Oil Development Proximity Map{% endblock %}

{% block content %}


<div class="top-banner">
  <div class="login-bar">
    <div class="login-content">
      {% if request.session.user %}
        Logged in as: <strong>&nbsp;{{ request.session.user.name|default:request.session.user.email }}</strong>
        <a href="/logout/" class="login-link">Logout</a>
      {% else %}
        <a href="/login/" class="login-link">Login</a>
      {% endif %}
    </div>
    <div class="login-actions" role="navigation" aria-label="Quick links">
      <button type="button" id="ownerProfileButton" class="login-action" title="Manage owner profile">
        <svg class="login-action__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 12.5a4.25 4.25 0 1 0 0-8.5 4.25 4.25 0 0 0 0 8.5Zm0 1.5c-4.07 0-7.5 2.78-7.5 6.02 0 .76.62 1.48 1.64 1.48h11.72c1.02 0 1.64-.72 1.64-1.48 0-3.24-3.43-6.02-7.5-6.02Z"/>
        </svg>
        <span class="login-action__label">Owner Profile</span>
      </button>
      <button type="button" class="login-action" title="Chat (coming soon)">
        <svg class="login-action__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M4.5 4A1.5 1.5 0 0 0 3 5.5v9A1.5 1.5 0 0 0 4.5 16H7v3.25a.75.75 0 0 0 1.22.57L13 16h6.5A1.5 1.5 0 0 0 21 14.5v-9A1.5 1.5 0 0 0 19.5 4h-15Z"/>
        </svg>
        <span class="login-action__label">Chat</span>
      </button>
    </div>
  </div>
  <div class="top-banner-row">
    <div class="top-banner-disclaimer">
      Below you will find your assets as best represented by public data and utilizing any data provided by you, the owner. Given the data available, we would value and purchase your royalties at the asset price shown above. If this interests you or think we missed something, please reach out. We want this dashboard to be helpful and an ongoing tool you can use. We will keep it updated monthly and you can access anytime you’d like for $4/month.
    </div>
  </div>
</div>
<div class="page-content">
  <div id="ownerProfileModal" class="profile-modal" aria-hidden="true">
    <div class="profile-modal__overlay" data-profile-close></div>
    <div class="profile-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ownerProfileTitle">
      <button type="button" class="profile-modal__close" data-profile-close aria-label="Close owner profile dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <div class="profile-modal__logo">
        <img src={% static 'mapapp/img/white_no_mane_logo.png' %} alt="Stable Energy Group logo">
      </div>
      <h2 id="ownerProfileTitle" class="profile-modal__title">Owner Profile</h2>
      <p class="profile-modal__subtitle">Keep your contact and tax information up to date so we can tailor insights for you.</p>
      <form id="ownerProfileForm" class="profile-form" autocomplete="on" data-user-email="{{ request.session.user.email|default:'' }}">
        <div class="profile-form-grid">
          <label class="profile-field">
            <span class="profile-field__label">Owner type<span aria-hidden="true">*</span></span>
            <select name="owner_type" class="profile-field__input" required>
              <option value="Individual">Individual</option>
              <option value="Entity">Entity</option>
              <option value="Trust">Trust</option>
              <option value="Corporation">Corporation</option>
            </select>
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Display name</span>
            <input name="display_name" type="text" class="profile-field__input" maxlength="120" placeholder="e.g., Skeans Family Minerals" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Email</span>
            <input name="email" type="email" class="profile-field__input" value="{{ request.session.user.email|default:'' }}" readonly />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Phone number</span>
            <input name="phone_number" type="tel" class="profile-field__input" maxlength="30" placeholder="(555) 555-5555" />
          </label>
        </div>

        <div class="profile-form-grid profile-form-grid--individual" data-owner-type="Individual">
          <label class="profile-field">
            <span class="profile-field__label">First name</span>
            <input name="first_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Last name</span>
            <input name="last_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
        </div>

        <div class="profile-form-grid profile-form-grid--entity" data-owner-type="Entity" data-owner-type-alt="Trust" data-owner-type-alt-2="Corporation">
          <label class="profile-field">
            <span class="profile-field__label">Main contact first name</span>
            <input name="contact_first_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Main contact last name</span>
            <input name="contact_last_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Contact title</span>
            <input name="contact_title" type="text" class="profile-field__input" maxlength="80" placeholder="Trustee, Manager, etc." />
          </label>
        </div>

        <fieldset class="profile-fieldset">
          <legend class="profile-fieldset__title">Mailing address</legend>
          <div class="profile-form-grid">
            <label class="profile-field profile-field--wide">
              <span class="profile-field__label">Address line 1</span>
              <input name="address_line_1" type="text" class="profile-field__input" maxlength="120" />
            </label>
            <label class="profile-field profile-field--wide">
              <span class="profile-field__label">Address line 2</span>
              <input name="address_line_2" type="text" class="profile-field__input" maxlength="120" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">City</span>
              <input name="city" type="text" class="profile-field__input" maxlength="80" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">State / Province</span>
              <input name="state" type="text" class="profile-field__input" maxlength="60" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">Postal code</span>
              <input name="postal_code" type="text" class="profile-field__input" maxlength="20" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">Country</span>
              <input name="country" type="text" class="profile-field__input" maxlength="60" />
            </label>
          </div>
        </fieldset>
      </form>
      <div id="ownerProfileMessage" class="profile-modal__message" role="status" aria-live="polite"></div>
    </div>
  </div>

  <div class="dashboard-layout">
    <aside class="metrics-sidebar">
      <div class="sidebar-logo">
        <img src={% static 'mapapp/img/white_no_mane_logo.png' %} alt="Stable Energy Group logo">
      </div>
      <div class="asset-value-box" id="asset-value-box">
        <span class="asset-label">Our estimated purchase price range:</span>
        <span class="asset-value-amount">--</span>
      </div>
      <div class="sidebar-kpis">
        <span id="user-wells-count" class="stat-box">
          <span class="stat-label">Well Count:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="avg-well-age" class="stat-box">
          <span class="stat-label">Avg. Well Age (Yrs):</span>
          <span class="stat-value">0</span>
        </span>
        <span id="effective-date" class="stat-box">
          <span class="stat-label">Effective Date:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="last-production-date" class="stat-box">
          <span class="stat-label">Last Production Date:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="last-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Last Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Last 12 Months Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="next-year-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Next 12 Months Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Last Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Last 12 Months Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="next-year-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Next 12 Months Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-cashflow" class="stat-box">
          <span class="stat-label">Last 12 Months Cash Flow:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="next-year-cashflow" class="stat-box">
          <span class="stat-label">Next 12 Months Cash Flow:</span>
          <span class="stat-value">--</span>
        </span>
      </div>
    </aside>
    <div class="main-content">
      <div class="chart-map-grid">
    <!-- Production chart (Plotly target) -->
    <section id="prod-chart" style="min-width:0; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
      <div class="section-header">
        <div class="section-title">
          <h3 class="card-title">Production History & Forecasts</h3>
          <button type="button" class="info-icon" aria-label="Show production chart information" aria-expanded="false" aria-controls="prod-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="prod-info-popup" class="info-box" role="note" hidden tabindex="-1">This chart shows historical and forecasted oil and gas production volumes for the assets where you hold a royalty interest. The royalty interests selected in the Well Summary table are combined to show total volumes.</div>
        </div>
      </div>
      <div id="prodChart"></div>
    </section>

    <!-- User Wells Map -->
    <section id="user-wells-map" style="min-width:0; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
      <div class="map-header section-header">
        <div class="map-title section-title">
          <h3 class="card-title">User Wells Map</h3>
          <button type="button" class="info-icon" aria-label="Show map information" aria-expanded="false" aria-controls="map-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="map-info-popup" class="map-info-box info-box" role="note" hidden tabindex="-1">This map shows all producing wells where you're recorded as having a royalty interest.</div>
        </div>
        <button id="mapStyleToggle" data-map-target="userWellsMap" style="background:white; color:#156082; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Satellite View</button>
      </div>
      <div id="userWellsMap"></div>
    </section>
  </div>

<section id="user-wells" style="margin-top:1rem; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
  <div class="well-table-toolbar">
    <h3 class="card-title">Well Summary Table</h3>
    <button type="button" id="wellSelectionToggle" class="well-select-toggle">Select All</button>
  </div>
  <div class="table-scroll">
  <table id="userWellsTable" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th style="width:48px;">Select</th>
        <th>Well API</th>
        <th>NRI</th>
        <th>Est. NRI Value</th>
        <th>Name</th>
        <th>Operator</th>
        <th>Trajectory</th>
        <th>Permit Date</th>
        <th>1st Prod Date</th>
        <th>Last Prod Date</th>
        <th>Gross Oil EUR</th>
        <th>Gross Gas EUR</th>
        <th>Net Oil EUR</th>
        <th>Net Gas EUR</th>
        <th>Remaining Net Oil</th>
        <th>Remaining Net Gas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  </section>

<div class="econ-grid">
  <div class="econ-grid__primary">
    <div class="econ-card" id="cashflow-window-card">
      <h4 class="econ-card-title">Net Cash Flow</h4>
      <div id="cashflowWindowChart" style="width:100%; height:400px;"></div>
    </div>
    <div class="econ-card econ-card--fixed-height" id="cashflow-summary-card">
      <h4 class="econ-card-title">Cumulative Net Cash Flow</h4>
      <div id="cashflowSummaryChart" class="chart-fill" style="width:100%; height:100%;"></div>
    </div>
  </div>
  <div class="econ-grid__secondary">
    <div class="econ-card">
      <h4 class="econ-card-title">Price Deck</h4>
      <div class="price-deck-controls">
        <label for="priceDeckSelect">Change Price Deck to Update Economics</label>
        <select id="priceDeckSelect"></select>
      </div>
      <div id="priceDeckChart" style="width:100%; height:371px;"></div>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:stretch;">
      <div id="royalty-value-card" class="econ-card econ-card--match-cashflow econ-card--fixed-height" style="flex:1 1 100%; min-width:0;">
        <h4 class="econ-card-title">Royalty Interest Value</h4>
        <div id="royaltyValueChart" class="chart-fill" style="width:100%; height:100%; min-height:0;"></div>
      </div>
    </div>
  </div>
</div>

  <section id="map-analysis" class="collapsible-card" style="margin-top:1rem; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
    <div class="collapsible-card__header">
      <h3 class="collapsible-card__title">Proximity Map</h3>
      <button type="button" class="collapsible-card__toggle" id="map-analysis-toggle" aria-expanded="false" aria-controls="map-analysis-content">Expand</button>
    </div>
    <div id="map-analysis-content" class="collapsible-card__body" hidden>
      <div class="map-description">
        This map shows the development over time of the area of the East Texas Basin around assets by adjusting the year slider. A 10-mile and 20-mile radius capture counts of wells proximal to the centroid of the assets. The color scheme shows the trend of development in the region. Light Green fades to black after ten years production (typically representing ~80-90% of expected ultimate recovery) and turns grey after producing +15 years (end of life production).
      </div>
      <div class="map-controls">
        <div class="slider-group">
          <label style="color: #ffff;"for="year">Change year to see development history:</label>
          <input id="year" max="2025" min="1950" step="1" type="range" value="2024"/>
          <span class="badge" id="year-val">2024</span>
        </div>
      </div>
      <!-- #ffff#cd8323 -->
      <div id="main-container">
        <div id="map-container">
          <div id="map"></div>
          <div id="color-legend">
            <h4>Well Age Color Guide</h4>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(0, 255, 0);"></div>
              <div class="legend-label">Recent Wells (≤3 years)</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(0, 128, 0);"></div>
              <div class="legend-label">4-10 years</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(100, 100, 100);"></div>
              <div class="legend-label">11-15 years</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(200, 200, 200);"></div>
              <div class="legend-label">Older Wells (&gt;15 years)</div>
            </div>
          </div>
        </div>
        <div id="chart-container">
          <!-- Switched order: 10-Mile first, then 20-Mile -->
          <div class="nearby-chart-block">
            <h3 class="nearby-chart-title">10-Mile Analysis</h3>
            <div id="nearby-chart-10" class="nearby-chart"></div>
          </div>
          <div class="nearby-chart-block">
            <h3 class="nearby-chart-title">20-Mile Analysis</h3>
            <div id="nearby-chart" class="nearby-chart"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="support-feedback-row">
    <section id="feedback-section" class="dashboard-panel">
      <h3 style="color:#fff; margin:0 0 .5rem 0; text-align:left;">Feedback</h3>
      <p class="panel-lead" style="color:#fff; margin-bottom:1rem; text-align:left;">
        Please provide feedback regarding any discrepancies or misrepresentations this application displays.
      </p>
      <div id="feedback-status" class="feedback-status" role="status" aria-live="polite"></div>
      <form id="feedback-form" style="display:flex; flex-direction:column; gap:0.75rem;">
        <textarea id="feedback-text" name="feedback" rows="8" placeholder="Enter your feedback here" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #0f4a63; resize:vertical; box-sizing:border-box;"></textarea>
        <button id="feedback-submit" type="submit" style="align-self:flex-end; background:#fff; color:#156082; border:none; padding:0.5rem 1.25rem; border-radius:6px; cursor:pointer; font-weight:600;">
          Submit Feedback
        </button>
      </form>
      <div id="feedback-history" class="feedback-history">
        <div class="feedback-history__table-wrapper">
          <table id="feedback-table" aria-describedby="feedback-status">
            <thead>
              <tr>
                <th scope="col">Submitted</th>
                <th scope="col">Feedback</th>
                <th scope="col" class="feedback-history__actions-header">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="feedback-empty" class="feedback-history__empty" role="note">No feedback submitted yet.</div>
        </div>
      </div>
    </section>

    <section id="supporting-docs" class="dashboard-panel">
      <h3 style="color:#fff; margin:0 0 .5rem 0; text-align:left;">Submit Supporting Documents</h3>
      <p class="panel-lead" style="color:#fff; margin-bottom:1rem; text-align:left;">
        Uploading documentation helps us validate ownership, enhance valuation accuracy, and provide more precise forecasts tailored to you.
      </p>
      <div class="support-docs-buttons">
        <button type="button" class="support-docs-button">
          <span class="button-title">Check Stubs</span>
          <span class="button-subtitle">We can utilize this to fine tune your value and provide better forecasts for you. We also anonymize gross wellbore volumes to improve our data. Every month you upload a checkstub we cut 50% off the next months fee.</span>
        </button>
        <button type="button" class="support-docs-button">
          <span class="button-title">Tract/Lease/Title Documents</span>
          <span class="button-subtitle">This will help us assure you own the minerals and can do full title runs or your assets by request for a small fee.</span>
        </button>
      </div>
      <div id="support-docs-status" class="support-docs-status" role="status" aria-live="polite"></div>
      <div class="support-docs-table-wrapper">
        <table id="support-docs-table" aria-describedby="support-docs-status">
          <thead>
            <tr>
              <th scope="col">Document</th>
              <th scope="col">Uploaded</th>
              <th scope="col">Comment</th>
              <th scope="col" class="support-docs-actions-header">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="support-docs-empty" class="support-docs-empty" role="note">No documents uploaded yet.</div>
      </div>
    </section>
  </div>

  <div class="mobile-experience-disclaimer" role="note">
    For the full experience, please visit this app on a computer or a tablet.
  </div>

    </div>
  </div>
</div>

  {% endblock %}

{% block scripts %}
  <script>
    (() => {
      const banner = document.querySelector('.top-banner');
      const siteHeader = document.querySelector('header');
      const root = document.documentElement;
      const GAP_PX = 15;

      if (!banner || !root) return;

      const applyBannerOffset = () => {
        const height = banner.getBoundingClientRect().height;
        const headerHeight = siteHeader ? siteHeader.getBoundingClientRect().height : 0;
        root.style.setProperty('--top-banner-height', `${height}px`);
        root.style.setProperty('--site-header-height', `${headerHeight}px`);
        root.style.setProperty('--top-banner-gap', `${GAP_PX}px`);
      };

      const resizeObserver = window.ResizeObserver ? new ResizeObserver(applyBannerOffset) : null;
      if (resizeObserver) {
        resizeObserver.observe(banner);
      }

      window.addEventListener('resize', applyBannerOffset);
      applyBannerOffset();
    })();

    (() => {
      const toggles = Array.from(document.querySelectorAll('[data-info-toggle]'))
        .map((button) => {
          const popupId = button.getAttribute('aria-controls');
          const popup = popupId ? document.getElementById(popupId) : null;
          return popup ? { button, popup } : null;
        })
        .filter(Boolean);

      if (!toggles.length) return;

      let active = null;

      const closePopup = (pair) => {
        if (!pair) return;
        pair.popup.hidden = true;
        pair.button.setAttribute('aria-expanded', 'false');
        if (active === pair) {
          active = null;
        }
      };

      const openPopup = (pair) => {
        if (!pair) return;
        if (active && active !== pair) {
          closePopup(active);
        }
        pair.popup.hidden = false;
        pair.button.setAttribute('aria-expanded', 'true');
        active = pair;
        pair.popup.focus();
      };

      toggles.forEach((pair) => {
        pair.button.addEventListener('click', (event) => {
          event.stopPropagation();
          if (pair.popup.hidden) {
            openPopup(pair);
          } else {
            closePopup(pair);
          }
        });
      });

      document.addEventListener('click', (event) => {
        if (!active) return;
        if (active.popup.contains(event.target) || active.button.contains(event.target)) return;
        closePopup(active);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && active) {
          const current = active;
          closePopup(current);
          current.button.focus();
        }
      });
    })();
  </script>
  <!-- existing app scripts -->
  <script src="{% static 'mapapp/js/main.js' %}?v=2025-08-25a"></script>

  <!-- production chart (must be last so it runs after main.js populates window.productionByApi) -->
  <script src="{% static 'mapapp/js/prod_chart_plotly.js' %}?v=2025-08-25a"></script>
  <script src="{% static 'mapapp/js/econ_charts.js' %}?v=2025-08-25a"></script>
{% endblock %}

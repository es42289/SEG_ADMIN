{% extends "base.html" %}
{% load static %}

{% block title %}Oil Development Proximity Map{% endblock %}

{% block content %}


<div class="top-banner">
  {% if admin_context %}
  <div class="admin-banner">
    <form method="post" action="{% url 'admin_select_user' %}" class="admin-banner__form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ current_path }}">
      <label class="admin-banner__label">Viewing as</label>
      <select name="selected_email" class="admin-banner__select" onchange="this.form.submit()">
        {% if admin_context.emails %}
          {% for email in admin_context.emails %}
            <option value="{{ email }}" {% if email == admin_context.selected_email %}selected{% endif %}>{{ email }}</option>
          {% endfor %}
        {% else %}
          <option value="">No users found</option>
        {% endif %}
      </select>
      <span class="admin-banner__contact">
        <span class="admin-banner__contact-label">Contact Name:</span>
        <span>{{ admin_context.contact_name|default:"Unknown" }}</span>
      </span>
      <button type="button" id="executiveDashButton" class="login-action" title="Executive dashboard overview">
        <span class="login-action__label">EXECUTIVE DASH</span>
      </button>
    </form>
  </div>
  {% endif %}
  <div class="login-bar">
    <div class="login-content">
      {% if request.session.user %}
        Logged in as: <strong>&nbsp;{{ request.session.user.name|default:request.session.user.email }}</strong>
        <a href="/logout/" class="login-link">Logout</a>
      {% else %}
        <a href="/login/" class="login-link">Login</a>
      {% endif %}
    </div>
    <div class="login-actions" role="navigation" aria-label="Quick links">
      <button type="button" id="ownerProfileButton" class="login-action" title="Manage owner profile">
        <svg class="login-action__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 12.5a4.25 4.25 0 1 0 0-8.5 4.25 4.25 0 0 0 0 8.5Zm0 1.5c-4.07 0-7.5 2.78-7.5 6.02 0 .76.62 1.48 1.64 1.48h11.72c1.02 0 1.64-.72 1.64-1.48 0-3.24-3.43-6.02-7.5-6.02Z"/>
        </svg>
        <span class="login-action__label">Owner Profile</span>
      </button>
      <button type="button" id="chatScrollButton" class="login-action" title="Chat (coming soon)">
        <svg class="login-action__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M4.5 4A1.5 1.5 0 0 0 3 5.5v9A1.5 1.5 0 0 0 4.5 16H7v3.25a.75.75 0 0 0 1.22.57L13 16h6.5A1.5 1.5 0 0 0 21 14.5v-9A1.5 1.5 0 0 0 19.5 4h-15Z"/>
        </svg>
        <span class="login-action__label">Chat</span>
      </button>
    </div>
  </div>
  <div class="top-banner-row">
    <div class="top-banner-disclaimer">
      Below you will find your assets as best represented by public data and utilizing any data provided by you, the owner. Given the data available, we would value and purchase your royalties at the asset price shown above. If this interests you or think we missed something, please reach out. We want this dashboard to be helpful and an ongoing tool you can use. We will keep it updated monthly and you can access anytime you’d like for $4/month.
    </div>
  </div>
</div>
<div class="page-content">
  <div id="ownerProfileModal" class="profile-modal" aria-hidden="true">
    <div class="profile-modal__overlay" data-profile-close></div>
    <div class="profile-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ownerProfileTitle">
      <button type="button" class="profile-modal__close" data-profile-close aria-label="Close owner profile dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <div class="profile-modal__logo">
        <img src={% static 'mapapp/img/white_no_mane_logo.png' %} alt="Stable Energy Group logo">
      </div>
      <h2 id="ownerProfileTitle" class="profile-modal__title">Owner Profile</h2>
      <p class="profile-modal__subtitle">Keep your contact and tax information up to date so we can tailor insights for you.</p>
      <form id="ownerProfileForm" class="profile-form" autocomplete="on" data-user-email="{{ request.session.user.email|default:'' }}">
        <div class="profile-form-grid">
          <label class="profile-field">
            <span class="profile-field__label">Owner type<span aria-hidden="true">*</span></span>
            <select name="owner_type" class="profile-field__input" required>
              <option value="Individual">Individual</option>
              <option value="Entity">Entity</option>
              <option value="Trust">Trust</option>
              <option value="Corporation">Corporation</option>
            </select>
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Display name</span>
            <input name="display_name" type="text" class="profile-field__input" maxlength="120" placeholder="e.g., Skeans Family Minerals" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Email</span>
            <input name="email" type="email" class="profile-field__input" value="{{ request.session.user.email|default:'' }}" readonly />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Phone number</span>
            <input name="phone_number" type="tel" class="profile-field__input" maxlength="30" placeholder="(555) 555-5555" />
          </label>
        </div>

        <div class="profile-form-grid profile-form-grid--individual" data-owner-type="Individual">
          <label class="profile-field">
            <span class="profile-field__label">First name</span>
            <input name="first_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Last name</span>
            <input name="last_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
        </div>

        <div class="profile-form-grid profile-form-grid--entity" data-owner-type="Entity" data-owner-type-alt="Trust" data-owner-type-alt-2="Corporation">
          <label class="profile-field">
            <span class="profile-field__label">Main contact first name</span>
            <input name="contact_first_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Main contact last name</span>
            <input name="contact_last_name" type="text" class="profile-field__input" maxlength="80" />
          </label>
          <label class="profile-field">
            <span class="profile-field__label">Contact title</span>
            <input name="contact_title" type="text" class="profile-field__input" maxlength="80" placeholder="Trustee, Manager, etc." />
          </label>
        </div>

        <fieldset class="profile-fieldset">
          <legend class="profile-fieldset__title">Mailing address</legend>
          <div class="profile-form-grid">
            <label class="profile-field profile-field--wide">
              <span class="profile-field__label">Address line 1</span>
              <input name="address_line_1" type="text" class="profile-field__input" maxlength="120" />
            </label>
            <label class="profile-field profile-field--wide">
              <span class="profile-field__label">Address line 2</span>
              <input name="address_line_2" type="text" class="profile-field__input" maxlength="120" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">City</span>
              <input name="city" type="text" class="profile-field__input" maxlength="80" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">State / Province</span>
              <input name="state" type="text" class="profile-field__input" maxlength="60" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">Postal code</span>
              <input name="postal_code" type="text" class="profile-field__input" maxlength="20" />
            </label>
            <label class="profile-field">
              <span class="profile-field__label">Country</span>
              <input name="country" type="text" class="profile-field__input" maxlength="60" />
            </label>
          </div>
        </fieldset>
      </form>
      <div id="ownerProfileMessage" class="profile-modal__message" role="status" aria-live="polite"></div>
    </div>
  </div>
  <div id="feedbackResponseModal" class="profile-modal" aria-hidden="true">
    <div class="profile-modal__overlay" data-feedback-close></div>
    <div class="profile-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="feedbackResponseTitle">
      <button type="button" class="profile-modal__close" data-feedback-close aria-label="Close feedback response dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <h2 id="feedbackResponseTitle" class="profile-modal__title">Feedback Response</h2>
      <p class="profile-modal__subtitle">Send a response that will appear below the user's feedback.</p>
      <form id="feedbackResponseForm" class="profile-form">
        <label class="profile-field profile-field--wide">
          <span class="profile-field__label">Response</span>
          <textarea id="feedbackResponseText" class="profile-field__input feedback-response__textarea" rows="5" placeholder="Enter your response here"></textarea>
        </label>
        <div class="feedback-response__actions">
          <button type="button" id="feedbackResponseDelete" class="feedback-response__button feedback-response__button--danger" disabled>Delete Response</button>
          <button type="button" class="feedback-response__button feedback-response__button--ghost" data-feedback-close>Cancel</button>
          <button type="submit" class="feedback-response__button">Save Response</button>
        </div>
      </form>
      <div id="feedbackResponseMessage" class="profile-modal__message" role="status" aria-live="polite"></div>
    </div>
  </div>
  <div id="executiveDashModal" class="profile-modal" aria-hidden="true">
    <div class="profile-modal__overlay" data-executive-close></div>
    <div class="profile-modal__dialog executive-modal" role="dialog" aria-modal="true" aria-labelledby="executiveDashTitle">
      <button type="button" class="profile-modal__close" data-executive-close aria-label="Close executive dashboard dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <div class="profile-modal__logo">
        <img src={% static 'mapapp/img/white_no_mane_logo.png' %} alt="Stable Energy Group logo">
      </div>
      <h2 id="executiveDashTitle" class="profile-modal__title">Executive Dashboard</h2>
      <p class="profile-modal__subtitle">Snapshot of owner engagement and support activity.</p>
      <div class="executive-stats">
        <div class="executive-stat">
          <span class="executive-stat__label">Claimed owner accounts</span>
          <span class="executive-stat__value">{{ executive_dashboard.owner_count|default:0 }}</span>
          <div class="executive-table">
            {% if executive_dashboard.owner_accounts %}
              <div class="executive-table__scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Owner Name</th>
                      <th>Claimed Email</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for account in executive_dashboard.owner_accounts %}
                      <tr>
                        <td>{{ account.owner_name }}</td>
                        <td>{{ account.email }}</td>
                        <td>
                          <button type="button" class="executive-table__button" data-executive-select-email="{{ account.email }}">
                            View as
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="executive-table__empty">No claimed owner accounts found.</p>
            {% endif %}
          </div>
        </div>
        <div class="executive-stat">
          <span class="executive-stat__label">Feedback items awaiting response</span>
          <span class="executive-stat__value">{{ executive_dashboard.pending_feedback_count|default:0 }}</span>
          <div class="executive-table">
            {% if executive_dashboard.feedback_overview %}
              <div class="executive-table__scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Owner Name</th>
                      <th>Total Feedback</th>
                      <th>Unanswered</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for entry in executive_dashboard.feedback_overview %}
                      <tr>
                        <td>{{ entry.owner_name }}</td>
                        <td>{{ entry.total_feedback }}</td>
                        <td class="executive-table__alert">{{ entry.unanswered_feedback }}</td>
                        <td>
                          <button type="button" class="executive-table__button" data-executive-select-email="{{ entry.email }}">
                            View as
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="executive-table__empty">No feedback entries found.</p>
            {% endif %}
          </div>
        </div>
        <div class="executive-stat">
          <span class="executive-stat__label">Documents uploaded</span>
          <span class="executive-stat__value">{{ executive_dashboard.document_count|default:0 }}</span>
          <div class="executive-table">
            {% if executive_dashboard.documents %}
              <div class="executive-table__scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Filename</th>
                      <th>Note</th>
                      <th>Size</th>
                      <th>Uploaded</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% regroup executive_dashboard.documents by user_email as documents_by_owner %}
                    {% for group in documents_by_owner %}
                      <tr class="executive-table__group">
                        <td colspan="5">{{ group.list.0.owner_name|default:group.grouper|default:"Unknown Owner" }}</td>
                      </tr>
                      {% for doc in group.list %}
                        <tr>
                          <td>{{ doc.filename }}</td>
                          <td>{{ doc.note|default:"--" }}</td>
                          <td>{{ doc.bytes|default:0 }}</td>
                          <td>{{ doc.created_at }}</td>
                          <td>
                            <button type="button" class="executive-table__button" data-executive-select-email="{{ doc.user_email }}">
                              View as
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="executive-table__empty">No documents found.</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% if not executive_dashboard.loaded %}
        <div class="profile-modal__message profile-modal__message--warning" role="status" aria-live="polite">
          Dashboard metrics are temporarily unavailable. Please try again later.
        </div>
      {% endif %}
    </div>
  </div>

  <div class="dashboard-layout">
    <aside class="metrics-sidebar">
      <div class="sidebar-logo">
        <img src={% static 'mapapp/img/white_no_mane_logo.png' %} alt="Stable Energy Group logo">
      </div>
      <div class="asset-value-box" id="asset-value-box">
        <div class="asset-value-header">
          <span class="asset-label">Our estimated purchase price range:</span>
          <button type="button" class="info-icon" aria-label="Show purchase price range information" aria-expanded="false" aria-controls="asset-value-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="asset-value-info-popup" class="info-box" role="note" hidden tabindex="-1">This is an estimated value based on the selected price deck used in the app. SEG typically utilizes a the current full strip for acquisitions.</div>
        </div>
        <span class="asset-value-amount">--</span>
      </div>
      <div class="sidebar-kpis">
        <span id="user-wells-count" class="stat-box">
          <span class="stat-label">Well Count:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="avg-well-age" class="stat-box">
          <span class="stat-label">Avg. Well Age (Yrs):</span>
          <span class="stat-value">0</span>
        </span>
        <span id="effective-date" class="stat-box">
          <span class="stat-label">Effective Date:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="last-production-date" class="stat-box">
          <span class="stat-label">Last Production Date:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="last-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Last Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Last 12 Months Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="next-year-oil" class="stat-box stat-box--oil">
          <span class="stat-label">Next 12 Months Oil, BBL:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Last Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Last 12 Months Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="next-year-gas" class="stat-box stat-box--gas">
          <span class="stat-label">Next 12 Months Gas, MCF:</span>
          <span class="stat-value">0</span>
        </span>
        <span id="last-year-cashflow" class="stat-box">
          <span class="stat-label">Last 12 Months Cash Flow:</span>
          <span class="stat-value">--</span>
        </span>
        <span id="next-year-cashflow" class="stat-box">
          <span class="stat-label">Next 12 Months Cash Flow:</span>
          <span class="stat-value">--</span>
        </span>
      </div>
    </aside>
    <div class="main-content">
      <div class="chart-map-grid">
    <!-- Production chart (Plotly target) -->
    <section id="prod-chart" style="min-width:0; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
      <div class="section-header">
        <div class="section-title">
          <h3 class="card-title">Production History & Forecasts</h3>
          <button type="button" class="info-icon" aria-label="Show production chart information" aria-expanded="false" aria-controls="prod-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="prod-info-popup" class="info-box" role="note" hidden tabindex="-1">This chart shows historical and forecasted oil and gas production volumes for the assets where you hold a royalty interest. The royalty interests selected in the Well Summary table are combined to show total volumes.</div>
        </div>
      </div>
      <div id="prodChart"></div>
    </section>

    <!-- User Wells Map -->
    <section id="user-wells-map" style="min-width:0; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
      <div class="map-header section-header">
        <div class="map-title section-title">
          <h3 class="card-title">User Wells Map</h3>
          <button type="button" class="info-icon" aria-label="Show map information" aria-expanded="false" aria-controls="map-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="map-info-popup" class="map-info-box info-box" role="note" hidden tabindex="-1">This map shows all producing wells where you're recorded as having a royalty interest.</div>
        </div>
        <button id="mapStyleToggle" data-map-target="userWellsMap" style="background:white; color:#156082; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Satellite View</button>
      </div>
      <div id="userWellsMap"></div>
    </section>
  </div>

<section id="user-wells" style="margin-top:1rem; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
  <div class="well-table-toolbar section-header">
    <div class="section-title">
      <h3 class="card-title">Well Summary Table</h3>
      <button type="button" class="info-icon" aria-label="Show well summary table information" aria-expanded="false" aria-controls="well-info-popup" data-info-toggle>
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
          <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          <circle cx="12" cy="6" r="1" fill="currentColor" />
        </svg>
      </button>
      <div id="well-info-popup" class="info-box" role="note" hidden tabindex="-1">This table contains information about each well where you have a royalty interest. Deselect assets to exclude them from the economic charts and summary statistics.</div>
    </div>
    <button type="button" id="wellSelectionToggle" class="well-select-toggle">Select All</button>
  </div>
  <div class="table-scroll">
  <table id="userWellsTable" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th style="width:48px;">Edit</th>
        <th style="width:150px;">DCA Approved</th>
        <th style="width:48px;">Select</th>
        <th>Well API</th>
        <th>NRI</th>
        <th>Est. NRI Value</th>
        <th>Name</th>
        <th>Operator</th>
        <th>Trajectory</th>
        <th>Permit Date</th>
        <th>1st Prod Date</th>
        <th>Last Prod Date</th>
        <th>Gross Oil EUR</th>
        <th>Gross Gas EUR</th>
        <th>Net Oil EUR</th>
        <th>Net Gas EUR</th>
        <th>Remaining Net Oil</th>
        <th>Remaining Net Gas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  </section>

  <div id="wellEditorModal" class="well-editor-modal" aria-hidden="true" data-is-admin="{{ admin_context.is_admin|yesno:'true,false' }}">
    <div class="well-editor-modal__overlay" data-well-editor-close></div>
    <div class="well-editor-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="wellEditorTitle">
      <button type="button" class="well-editor-modal__close" data-well-editor-close aria-label="Close well editor dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <header class="well-editor-modal__header">
        <div>
          <p class="well-editor-modal__eyebrow">Well Forecast Editor</p>
          <h2 id="wellEditorTitle" class="well-editor-modal__title">Well Inputs</h2>
        </div>
        <div class="well-editor-modal__header-actions">
          <button type="button" id="wellEditorFastEdit" class="well-editor-fast-edit">FAST EDIT</button>
          <button type="button" id="wellEditorSave" class="well-editor-save">Save Parameters</button>
        </div>
      </header>

      <div class="well-editor-layout">
        <div class="well-editor-left">
          <div class="well-editor-modal__chart">
            <div id="wellEditorChart"></div>
          </div>

          <div class="well-editor-metrics">
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Gross Oil EUR (BBL)</span>
              <span id="wellEditorGrossOilEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Gross Gas EUR (MCF)</span>
              <span id="wellEditorGrossGasEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Net Oil EUR (BBL)</span>
              <span id="wellEditorNetOilEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Net Gas EUR (MCF)</span>
              <span id="wellEditorNetGasEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric well-editor-metric--wide">
              <span class="well-editor-metric__label">Estimated NRI Value</span>
              <span class="well-editor-metric__value">
                <span id="wellEditorNriValue">--</span>
                <span class="well-editor-metric__percent">(NRI: <span id="wellEditorNriPercent">--</span>%)</span>
              </span>
            </div>
          </div>

          <div id="wellEditorStatus" class="well-editor-status" role="status" aria-live="polite"></div>
        </div>

        <div class="well-editor-right">
          <div class="well-editor-toggle">
            <button type="button" class="well-editor-toggle__button is-active" data-well-editor-tab="oil">Oil Inputs</button>
            <button type="button" class="well-editor-toggle__button" data-well-editor-tab="gas">Gas Inputs</button>
          </div>

          <div class="well-editor-form">
            <div class="well-editor-form__section" data-well-editor-section="oil">
              <h3 class="well-editor-form__title">Oil Forecast Inputs</h3>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilQi">Oil qi (BBL)</label>
                  <span class="well-editor-field__value" data-field-value="OIL_CALC_QI">--</span>
                </div>
                <input id="wellOilQi" type="range" min="0" max="10000" step="10" data-field="OIL_CALC_QI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilQf">Oil qf min (BBL)</label>
                  <span class="well-editor-field__value" data-field-value="OIL_Q_MIN">--</span>
                </div>
                <input id="wellOilQf" type="range" min="0" max="500" step="1" data-field="OIL_Q_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilDi">Oil Di (annual)</label>
                  <span class="well-editor-field__value" data-field-value="OIL_EMPIRICAL_DI">--</span>
                </div>
                <input id="wellOilDi" type="range" min="0" max="1" step="0.01" data-field="OIL_EMPIRICAL_DI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilB">Oil b-factor</label>
                  <span class="well-editor-field__value" data-field-value="OIL_CALC_B_FACTOR">--</span>
                </div>
                <input id="wellOilB" type="range" min="0.8" max="2" step="0.01" data-field="OIL_CALC_B_FACTOR">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilDmin">Oil terminal decline (annual)</label>
                  <span class="well-editor-field__value" data-field-value="OIL_D_MIN">--</span>
                </div>
                <input id="wellOilDmin" type="range" min="0" max="0.5" step="0.005" data-field="OIL_D_MIN">
              </div>
              <div class="well-editor-field">
                <label for="wellOilDeclineType">Oil Decline Type</label>
                <select id="wellOilDeclineType" data-field="OIL_DECLINE_TYPE">
                  <option value="EXP">Exponential</option>
                  <option value="HYP">Hyperbolic</option>
                </select>
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellOilStart">Oil Forecast Start</label>
                  <span class="well-editor-field__value" data-field-value="FCST_START_OIL">--</span>
                </div>
                <input id="wellOilStart" type="range" data-field="FCST_START_OIL">
              </div>
            </div>

            <div class="well-editor-form__section" data-well-editor-section="gas" hidden>
              <h3 class="well-editor-form__title">Gas Forecast Inputs</h3>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasQi">Gas qi (MCF)</label>
                  <span class="well-editor-field__value" data-field-value="GAS_CALC_QI">--</span>
                </div>
                <input id="wellGasQi" type="range" min="0" max="50000" step="50" data-field="GAS_CALC_QI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasQf">Gas qf min (MCF)</label>
                  <span class="well-editor-field__value" data-field-value="GAS_Q_MIN">--</span>
                </div>
                <input id="wellGasQf" type="range" min="0" max="1000" step="1" data-field="GAS_Q_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasDi">Gas Di (annual)</label>
                  <span class="well-editor-field__value" data-field-value="GAS_EMPIRICAL_DI">--</span>
                </div>
                <input id="wellGasDi" type="range" min="0" max="1" step="0.01" data-field="GAS_EMPIRICAL_DI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasB">Gas b-factor</label>
                  <span class="well-editor-field__value" data-field-value="GAS_CALC_B_FACTOR">--</span>
                </div>
                <input id="wellGasB" type="range" min="0.8" max="2" step="0.01" data-field="GAS_CALC_B_FACTOR">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasDmin">Gas terminal decline (annual)</label>
                  <span class="well-editor-field__value" data-field-value="GAS_D_MIN">--</span>
                </div>
                <input id="wellGasDmin" type="range" min="0" max="0.5" step="0.005" data-field="GAS_D_MIN">
              </div>
              <div class="well-editor-field">
                <label for="wellGasDeclineType">Gas Decline Type</label>
                <select id="wellGasDeclineType" data-field="GAS_DECLINE_TYPE">
                  <option value="EXP">Exponential</option>
                  <option value="HYP">Hyperbolic</option>
                </select>
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasStart">Gas Forecast Start</label>
                  <span class="well-editor-field__value" data-field-value="FCST_START_GAS">--</span>
                </div>
                <input id="wellGasStart" type="range" data-field="FCST_START_GAS">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <label for="wellGasYears">Gas Forecast Years</label>
                  <span class="well-editor-field__value" data-field-value="GAS_FCST_YRS">--</span>
                </div>
                <input id="wellGasYears" type="range" min="0" max="50" step="1" data-field="GAS_FCST_YRS">
              </div>
            </div>
          </div>

          <div class="well-editor-actions">
            <label class="well-editor-approval">
              <input id="wellEditorApproved" type="checkbox" data-field="APPROVED">
              <span>DCA Approved</span>
            </label>
            <button type="button" id="wellEditorLoadApproved" class="well-editor-load-approved">Load Approved DCA</button>
            <button type="button" id="wellEditorDownload" class="well-editor-download">Download CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="wellFastEditModal" class="fast-edit-modal" aria-hidden="true">
    <div class="fast-edit-modal__overlay" data-fast-edit-close></div>
    <div class="fast-edit-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="fastEditTitle">
      <header class="fast-edit-modal__header">
        <div>
          <p class="fast-edit-modal__eyebrow">Well Forecast Fast Edit</p>
          <h2 id="fastEditTitle" class="fast-edit-modal__title">FAST EDIT</h2>
        </div>
        <div class="fast-edit-modal__controls">
          <span id="fastEditModeLabel" class="fast-edit-mode-label">Editing: Gas</span>
          <button type="button" id="fastEditModeToggle" class="fast-edit-toggle">Switch to Oil</button>
          <button type="button" id="fastEditReset" class="fast-edit-reset">Reset Parameters</button>
          <div class="fast-edit-decline-toggle">
            <span id="fastEditDeclineLabel" class="fast-edit-decline-label">Decline: Exponential</span>
            <label class="fast-edit-switch">
              <input
                type="checkbox"
                id="fastEditDeclineToggle"
                class="fast-edit-switch__input"
                role="switch"
                aria-label="Toggle decline type between exponential and hyperbolic"
              >
              <span class="fast-edit-switch__slider" aria-hidden="true"></span>
            </label>
          </div>
          <button type="button" class="fast-edit-modal__close" data-fast-edit-close aria-label="Close fast edit view">
            ×
          </button>
        </div>
      </header>
      <div class="fast-edit-modal__content">
        <div class="fast-edit-modal__chart">
          <div id="wellFastEditChart"></div>
          <div id="fastEditPadLeft" class="fast-edit-pad fast-edit-pad--left" aria-hidden="true">
            <span class="fast-edit-pad__label">↕ qᵢ<br>↔ start date</span>
          </div>
          <div id="fastEditPadRight" class="fast-edit-pad fast-edit-pad--right" aria-hidden="true">
            <span class="fast-edit-pad__label">↕ Dᵢ<br>↔ b</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="econ-grid">
  <div class="econ-grid__primary">
    <div class="econ-card" id="cashflow-window-card">
      <div class="section-header">
        <div class="section-title">
          <h4 class="econ-card-title">Net Cash Flow</h4>
          <button type="button" class="info-icon" aria-label="Show net cash flow information" aria-expanded="false" aria-controls="cashflow-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="cashflow-info-popup" class="info-box" role="note" hidden tabindex="-1">This chart shows approximated net cash flows from your selected royalty interests for the last 12 months and the next 24 months. If historical cash flows look incorrect, submit feedback or documentation below so we can correct them.</div>
        </div>
      </div>
      <div id="cashflowWindowChart" style="width:100%; height:400px;"></div>
    </div>
    <div class="econ-card econ-card--fixed-height" id="cashflow-summary-card">
      <div class="section-header">
        <div class="section-title">
          <h4 class="econ-card-title">Cumulative Net Cash Flow</h4>
          <button type="button" class="info-icon" aria-label="Show cumulative net cash flow information" aria-expanded="false" aria-controls="cumulative-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="cumulative-info-popup" class="info-box" role="note" hidden tabindex="-1">This chart tracks cumulative net cash flow for your selected royalty interests, rolling together historical results with projected future receipts.</div>
        </div>
      </div>
      <div id="cashflowSummaryChart" class="chart-fill" style="width:100%; height:100%;"></div>
    </div>
  </div>
  <div class="econ-grid__secondary">
    <div class="econ-card">
      <div class="section-header">
        <div class="section-title">
          <h4 class="econ-card-title">Price Deck</h4>
          <button type="button" class="info-icon" aria-label="Show price deck information" aria-expanded="false" aria-controls="price-info-popup" data-info-toggle>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
              <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <circle cx="12" cy="6" r="1" fill="currentColor" />
            </svg>
          </button>
          <div id="price-info-popup" class="info-box" role="note" hidden tabindex="-1">These price scenarios drive the economic calculations. Select a price deck to update forecasts and valuations for your chosen royalty interests.</div>
        </div>
      </div>
      <div class="price-deck-controls">
        <label for="priceDeckSelect">Change Price Deck to Update Economics</label>
        <select id="priceDeckSelect"></select>
      </div>
      <div id="priceDeckChart" style="width:100%; height:371px;"></div>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:stretch;">
      <div id="royalty-value-card" class="econ-card econ-card--match-cashflow econ-card--fixed-height" style="flex:1 1 100%; min-width:0;">
        <div class="section-header">
          <div class="section-title">
            <h4 class="econ-card-title">Royalty Interest Value</h4>
            <button type="button" class="info-icon" aria-label="Show royalty interest value information" aria-expanded="false" aria-controls="value-info-popup" data-info-toggle>
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
                <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <circle cx="12" cy="6" r="1" fill="currentColor" />
              </svg>
            </button>
            <div id="value-info-popup" class="info-box" role="note" hidden tabindex="-1">This view shows the total value of your selected royalty interest <u>at different points in time</u> using the active price deck and production outlook.</div>
          </div>
        </div>
        <div id="royaltyValueChart" class="chart-fill" style="width:100%; height:100%; min-height:0;"></div>
      </div>
    </div>
  </div>
</div>

  <section id="map-analysis" class="collapsible-card" style="margin-top:1rem; padding:1rem; border-radius:12px; border:1px solid #156082; background:#156082;">
    <div class="collapsible-card__header section-header">
      <div class="section-title">
        <h3 class="collapsible-card__title">Proximity Map</h3>
        <button type="button" class="info-icon" aria-label="Show proximity map information" aria-expanded="false" aria-controls="proximity-map-info-popup" data-info-toggle>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <line x1="12" y1="9" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <circle cx="12" cy="6" r="1" fill="currentColor" />
          </svg>
        </button>
        <div id="proximity-map-info-popup" class="info-box info-box--full" role="note" hidden tabindex="-1">This map shows the development over time of the area of the East Texas Basin around assets by adjusting the year slider. A 10-mile and 20-mile radius capture counts of wells proximal to the centroid of the assets. The color scheme shows the trend of development in the region. Light Green fades to black after ten years production (typically representing ~80-90% of expected ultimate recovery) and turns grey after producing +15 years (end of life production).</div>
      </div>
      <button type="button" class="collapsible-card__toggle" id="map-analysis-toggle" aria-expanded="false" aria-controls="map-analysis-content">Expand</button>
    </div>
    <div id="map-analysis-content" class="collapsible-card__body" hidden>
      <div class="map-controls">
        <div class="slider-group">
          <label style="color: #ffff;"for="year">Change year to see development history:</label>
          <input id="year" max="2025" min="1950" step="1" type="range" value="2024"/>
          <span class="badge" id="year-val">2024</span>
        </div>
      </div>
      <!-- #ffff#cd8323 -->
      <div id="main-container">
        <div id="map-container">
          <div id="map"></div>
          <div id="color-legend">
            <h4>Well Age Color Guide</h4>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(0, 255, 0);"></div>
              <div class="legend-label">Recent Wells (≤3 years)</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(0, 128, 0);"></div>
              <div class="legend-label">4-10 years</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(100, 100, 100);"></div>
              <div class="legend-label">11-15 years</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: rgb(200, 200, 200);"></div>
              <div class="legend-label">Older Wells (&gt;15 years)</div>
            </div>
          </div>
        </div>
        <div id="chart-container">
          <!-- Switched order: 10-Mile first, then 20-Mile -->
          <div class="nearby-chart-block">
            <h3 class="nearby-chart-title">10-Mile Analysis</h3>
            <div id="nearby-chart-10" class="nearby-chart"></div>
          </div>
          <div class="nearby-chart-block">
            <h3 class="nearby-chart-title">20-Mile Analysis</h3>
            <div id="nearby-chart" class="nearby-chart"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="support-feedback-row">
    <section id="feedback-section" class="dashboard-panel" tabindex="-1" data-is-admin="{{ admin_context.is_admin|yesno:'true,false' }}">
      <h3 style="color:#fff; margin:0 0 .4rem 0; text-align:left;">Feedback</h3>
      <p class="panel-lead" style="color:#fff; margin-bottom:0.9rem; text-align:left;">
        Please provide feedback regarding any discrepancies or misrepresentations this application displays.
      </p>
      <div id="feedback-status" class="feedback-status" role="status" aria-live="polite"></div>
      <form id="feedback-form" style="display:flex; flex-direction:column; gap:0.65rem;">
        <textarea id="feedback-text" name="feedback" rows="7" placeholder="Enter your feedback here" style="width:100%; padding:0.65rem; border-radius:8px; border:1px solid #0f4a63; resize:vertical; box-sizing:border-box;"></textarea>
        <button id="feedback-submit" type="submit" style="align-self:flex-end; background:#fff; color:#156082; border:none; padding:0.45rem 1.1rem; border-radius:6px; cursor:pointer; font-weight:600;">
          Submit Feedback
        </button>
      </form>
      <div id="feedback-history" class="feedback-history">
        <div class="feedback-history__table-wrapper">
          <table id="feedback-table" aria-describedby="feedback-status">
            <thead>
              <tr>
                <th scope="col">Submitted</th>
                <th scope="col">Feedback</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="feedback-empty" class="feedback-history__empty" role="note">No feedback submitted yet.</div>
        </div>
      </div>
    </section>

    <section id="supporting-docs" class="dashboard-panel">
      <h3 style="color:#fff; margin:0 0 .4rem 0; text-align:left;">Submit Supporting Documents</h3>
      <p class="panel-lead" style="color:#fff; margin-bottom:0.9rem; text-align:left;">
        Uploading documentation helps us validate ownership, enhance valuation accuracy, and provide more precise forecasts tailored to you.
      </p>
      <div class="support-docs-buttons">
        <button type="button" class="support-docs-button">
          <span class="button-title">Check Stubs</span>
          <span class="button-subtitle">We can utilize this to fine tune your value and provide better forecasts for you. We also anonymize gross wellbore volumes to improve our data. Every month you upload a checkstub we cut 50% off the next months fee.</span>
        </button>
        <button type="button" class="support-docs-button">
          <span class="button-title">Tract/Lease/Title Documents</span>
          <span class="button-subtitle">This will help us assure you own the minerals and can do full title runs or your assets by request for a small fee.</span>
        </button>
      </div>
      <div id="support-docs-status" class="support-docs-status" role="status" aria-live="polite"></div>
      <div class="support-docs-table-wrapper">
        <table id="support-docs-table" aria-describedby="support-docs-status">
          <thead>
            <tr>
              <th scope="col">Document</th>
              <th scope="col">Uploaded</th>
              <th scope="col">Comment</th>
              <th scope="col" class="support-docs-actions-header">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="support-docs-empty" class="support-docs-empty" role="note">No documents uploaded yet.</div>
      </div>
    </section>
  </div>

  <div class="mobile-experience-disclaimer" role="note">
    For the full experience, please visit this app on a computer or a tablet.
  </div>

    </div>
  </div>
</div>

  {% endblock %}

{% block scripts %}
  <script>
    (() => {
      const banner = document.querySelector('.top-banner');
      const siteHeader = document.querySelector('header');
      const root = document.documentElement;
      const GAP_PX = 15;

      if (!banner || !root) return;

      const applyBannerOffset = () => {
        const height = banner.getBoundingClientRect().height;
        const headerHeight = siteHeader ? siteHeader.getBoundingClientRect().height : 0;
        root.style.setProperty('--top-banner-height', `${height}px`);
        root.style.setProperty('--site-header-height', `${headerHeight}px`);
        root.style.setProperty('--top-banner-gap', `${GAP_PX}px`);
      };

      const resizeObserver = window.ResizeObserver ? new ResizeObserver(applyBannerOffset) : null;
      if (resizeObserver) {
        resizeObserver.observe(banner);
      }

      window.addEventListener('resize', applyBannerOffset);
      applyBannerOffset();
    })();

    (() => {
      const toggles = Array.from(document.querySelectorAll('[data-info-toggle]'))
        .map((button) => {
          const popupId = button.getAttribute('aria-controls');
          const popup = popupId ? document.getElementById(popupId) : null;
          return popup ? { button, popup } : null;
        })
        .filter(Boolean);

      if (!toggles.length) return;

      let active = null;

      const closePopup = (pair) => {
        if (!pair) return;
        pair.popup.hidden = true;
        pair.button.setAttribute('aria-expanded', 'false');
        if (active === pair) {
          active = null;
        }
      };

      const openPopup = (pair) => {
        if (!pair) return;
        if (active && active !== pair) {
          closePopup(active);
        }
        pair.popup.hidden = false;
        pair.button.setAttribute('aria-expanded', 'true');
        active = pair;
        pair.popup.focus();
      };

      toggles.forEach((pair) => {
        pair.button.addEventListener('click', (event) => {
          event.stopPropagation();
          if (pair.popup.hidden) {
            openPopup(pair);
          } else {
            closePopup(pair);
          }
        });
      });

      document.addEventListener('click', (event) => {
        if (!active) return;
        if (active.popup.contains(event.target) || active.button.contains(event.target)) return;
        closePopup(active);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && active) {
          const current = active;
          closePopup(current);
          current.button.focus();
        }
      });
    })();
  </script>
  <!-- existing app scripts -->
  <script src="{% static 'mapapp/js/main.js' %}?v=2025-08-25a"></script>

  <!-- production chart (must be last so it runs after main.js populates window.productionByApi) -->
  <script src="{% static 'mapapp/js/prod_chart_plotly.js' %}?v=2025-08-25a"></script>
  <script src="{% static 'mapapp/js/econ_charts.js' %}?v=2025-08-25a"></script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}Wellset Explorer{% endblock %}

{% block content %}
<div class="page-content well-explorer">
  <section class="well-explorer-card">
    <header class="well-explorer-card__header">
      <div class="well-explorer-card__actions">
        <button type="button" class="well-explorer-button" id="applyWellExplorerFilters">Apply Filters</button>
        <button type="button" class="well-explorer-button well-explorer-button--ghost" id="clearWellExplorerFilters">Clear Filters</button>
        <button type="button" class="well-explorer-button well-explorer-button--ghost" id="clearWellExplorerSelection">Clear Selection</button>
      </div>
    </header>

    <div class="well-explorer-grid">
      <div class="well-explorer-panel">
        <h2 class="well-explorer-panel__title">Filter Wells</h2>
        <div class="well-explorer-filters" id="wellExplorerFilters"></div>
        <div class="well-explorer-csv">
          <label class="well-explorer-panel__title" for="wellExplorerCsv">Paste API10 CSV</label>
          <p class="well-explorer-help">
            Acceptable format: one API10 per line, or comma-separated. Example:
            <span class="well-explorer-help__example">4246139296</span> or
            <span class="well-explorer-help__example">42-461-39296</span>.
            Headers are optional (e.g., <code>API_UWI</code> or <code>API10</code>).
          </p>
          <textarea id="wellExplorerCsv" class="well-explorer-textarea" rows="5" placeholder="API10&#10;42-461-39296&#10;4246139296"></textarea>
          <button type="button" class="well-explorer-button well-explorer-button--ghost" id="applyWellExplorerCsv">Apply API List</button>
        </div>
      </div>

      <div class="well-explorer-panel">
        <div class="well-explorer-panel__header">
          <h2 class="well-explorer-panel__title">Well Map</h2>
          <p class="well-explorer-panel__meta">
            Selected wells: <span id="wellExplorerSelectedCount">0</span>
          </p>
        </div>
        <div id="wellExplorerMap" class="well-explorer-map" aria-label="Well explorer map"></div>
        <p class="well-explorer-help">Click any well on the map to add it to the selection.</p>
      </div>
    </div>

    <div class="well-explorer-wellset-bar">
      <div class="well-explorer-wellset-field">
        <label class="well-explorer-panel__title" for="wellExplorerWellsetSelect">Saved Wellsets</label>
        <select id="wellExplorerWellsetSelect" class="well-explorer-input">
          <option value="">Select a saved wellset</option>
        </select>
      </div>
      <div class="well-explorer-wellset-field">
        <label class="well-explorer-panel__title" for="wellExplorerWellsetName">Wellset Name</label>
        <input
          id="wellExplorerWellsetName"
          class="well-explorer-input"
          placeholder="Type a new wellset name"
          autocomplete="off"
        >
      </div>
      <div class="well-explorer-wellset-actions">
        <button type="button" class="well-explorer-button" id="saveWellsetButton">Save Wellset</button>
        <span id="wellExplorerWellsetStatus" class="well-explorer-wellset-status is-unsaved">Wellset not saved yet</span>
      </div>
    </div>

    <div class="well-explorer-table-wrap">
      <h2 class="well-explorer-panel__title">Selected Wells</h2>
      <table class="well-explorer-table">
        <thead>
          <tr>
            <th>API/UWI</th>
            <th>Well Name</th>
            <th>County</th>
            <th>Operator</th>
            <th>Status</th>
            <th>Trajectory</th>
            <th>DCA Approved</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="wellExplorerTableBody">
          <tr>
            <td colspan="8" class="well-explorer-table__empty">No wells selected yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <div id="wellEditorModal" class="well-editor-modal" aria-hidden="true" data-is-admin="{{ admin_context.is_admin|yesno:'true,false' }}">
    <div class="well-editor-modal__overlay" data-well-editor-close></div>
    <div class="well-editor-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="wellEditorWellSelect">
      <button type="button" class="well-editor-modal__close" data-well-editor-close aria-label="Close well editor dialog">
        <span aria-hidden="true">&times;</span>
      </button>
      <header class="well-editor-modal__header">
        <div>
          <p class="well-editor-modal__eyebrow">Well Forecast Editor</p>
          <h2 class="well-editor-modal__title">Edit Well Forecast</h2>
          <select id="wellEditorWellSelect" class="well-editor-well-select" aria-label="Select well">
            <option value="">Select a well...</option>
          </select>
        </div>
        <div class="well-editor-modal__header-actions">
          <button type="button" id="wellEditorFastEdit" class="well-editor-fast-edit">FAST EDIT</button>
        </div>
      </header>
      <div class="well-editor-layout">
        <div class="well-editor-left">
          <div class="well-editor-modal__chart">
            <div id="wellEditorChart"></div>
          </div>
          <div class="well-editor-metrics">
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Gross Oil EUR (BBL)</span>
              <span id="wellEditorGrossOilEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric">
              <span class="well-editor-metric__label">Gross Gas EUR (MCF)</span>
              <span id="wellEditorGrossGasEur" class="well-editor-metric__value">--</span>
            </div>
            <div class="well-editor-metric well-editor-metric--wide">
              <span class="well-editor-metric__label">Estimated NRI Value</span>
              <span class="well-editor-metric__value">
                <span id="wellEditorNriValue">--</span>
                <span class="well-editor-metric__percent">(NRI: <span id="wellEditorNriPercent">--</span>%)</span>
              </span>
            </div>
          </div>
        </div>
        <div class="well-editor-right">
          <div class="well-editor-toggle">
            <button type="button" class="well-editor-toggle__button is-active" data-well-editor-tab="oil">Oil Inputs</button>
            <button type="button" class="well-editor-toggle__button" data-well-editor-tab="gas">Gas Inputs</button>
          </div>
          <div class="well-editor-form">
            <div class="well-editor-form__section" data-well-editor-section="oil">
              <h3 class="well-editor-form__title">Oil Forecast Inputs</h3>
              <div class="well-editor-field well-editor-field--inline">
                <label class="well-editor-field__label">Oil Decline Type</label>
                <div class="well-editor-decline-toggle">
                  <span id="wellEditorOilDeclineLabel" class="well-editor-decline-label">Exponential</span>
                  <label class="well-editor-switch">
                    <input type="checkbox" class="well-editor-switch__input" data-field="OIL_DECLINE_TYPE">
                    <span class="well-editor-switch__slider" aria-hidden="true"></span>
                  </label>
                </div>
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Forecast Start</span>
                  <span class="well-editor-field__value" data-field-value="FCST_START_OIL">--</span>
                </div>
                <input type="range" min="0" max="50000" step="1" data-field="FCST_START_OIL">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Forecast Years</span>
                  <span class="well-editor-field__value" data-field-value="OIL_FCST_YRS">--</span>
                </div>
                <input type="range" min="1" max="50" step="1" data-field="OIL_FCST_YRS">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Qi (bbl/month)</span>
                  <span class="well-editor-field__value" data-field-value="OIL_CALC_QI">--</span>
                </div>
                <input type="range" min="0" max="100000" step="10" data-field="OIL_CALC_QI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Qmin (bbl/month)</span>
                  <span class="well-editor-field__value" data-field-value="OIL_Q_MIN">--</span>
                </div>
                <input type="range" min="0" max="10000" step="1" data-field="OIL_Q_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Di (annual)</span>
                  <span class="well-editor-field__value" data-field-value="OIL_EMPIRICAL_DI">--</span>
                </div>
                <input type="range" min="0.04" max="0.5" step="0.005" data-field="OIL_EMPIRICAL_DI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Dmin (annual)</span>
                  <span class="well-editor-field__value" data-field-value="OIL_D_MIN">--</span>
                </div>
                <input type="range" min="0.02" max="0.1" step="0.005" data-field="OIL_D_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">b</span>
                  <span class="well-editor-field__value" data-field-value="OIL_CALC_B_FACTOR">--</span>
                </div>
                <input type="range" min="0.5" max="1.1" step="0.01" data-field="OIL_CALC_B_FACTOR">
              </div>
            </div>
            <div class="well-editor-form__section" data-well-editor-section="gas" hidden>
              <h3 class="well-editor-form__title">Gas Forecast Inputs</h3>
              <div class="well-editor-field well-editor-field--inline">
                <label class="well-editor-field__label">Gas Decline Type</label>
                <div class="well-editor-decline-toggle">
                  <span id="wellEditorGasDeclineLabel" class="well-editor-decline-label">Exponential</span>
                  <label class="well-editor-switch">
                    <input type="checkbox" class="well-editor-switch__input" data-field="GAS_DECLINE_TYPE">
                    <span class="well-editor-switch__slider" aria-hidden="true"></span>
                  </label>
                </div>
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Forecast Start</span>
                  <span class="well-editor-field__value" data-field-value="FCST_START_GAS">--</span>
                </div>
                <input type="range" min="0" max="50000" step="1" data-field="FCST_START_GAS">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Forecast Years</span>
                  <span class="well-editor-field__value" data-field-value="GAS_FCST_YRS">--</span>
                </div>
                <input type="range" min="1" max="50" step="1" data-field="GAS_FCST_YRS">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Qi (MCF/month)</span>
                  <span class="well-editor-field__value" data-field-value="GAS_CALC_QI">--</span>
                </div>
                <input type="range" min="0" max="100000" step="10" data-field="GAS_CALC_QI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Qmin (MCF/month)</span>
                  <span class="well-editor-field__value" data-field-value="GAS_Q_MIN">--</span>
                </div>
                <input type="range" min="0" max="10000" step="1" data-field="GAS_Q_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Di (annual)</span>
                  <span class="well-editor-field__value" data-field-value="GAS_EMPIRICAL_DI">--</span>
                </div>
                <input type="range" min="0.04" max="0.5" step="0.005" data-field="GAS_EMPIRICAL_DI">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">Dmin (annual)</span>
                  <span class="well-editor-field__value" data-field-value="GAS_D_MIN">--</span>
                </div>
                <input type="range" min="0.02" max="0.1" step="0.005" data-field="GAS_D_MIN">
              </div>
              <div class="well-editor-field">
                <div class="well-editor-field__header">
                  <span class="well-editor-field__label">b</span>
                  <span class="well-editor-field__value" data-field-value="GAS_CALC_B_FACTOR">--</span>
                </div>
                <input type="range" min="0.5" max="1.1" step="0.01" data-field="GAS_CALC_B_FACTOR">
              </div>
            </div>

          </div>
          <div class="well-editor-actions">
            <label class="well-editor-approval">
              <input type="checkbox" id="wellEditorApproved" data-field="DCA_APPROVED" />
              <span>Approved DCA</span>
            </label>
            <button type="button" id="wellEditorSave" class="well-editor-save">Save Parameters</button>
            <button type="button" id="wellEditorLoadApproved" class="well-editor-load-approved">Reset to Last Approved</button>
            <button type="button" id="wellEditorDownload" class="well-editor-download">Download CSV</button>
          </div>
        </div>
        <div class="well-editor-form__section well-editor-gpt">
          <h3 class="well-editor-form__title">GPT Inputs</h3>
          <div class="well-editor-field">
            <label class="well-editor-field__label" for="wellEditorEconScenario">Economic Scenario</label>
            <select id="wellEditorEconScenario" data-field="ECON_SCENARIO"></select>
          </div>
          <p id="wellEditorGptWarning" class="well-editor-warning" hidden>GPT parameters are not saved to well.</p>
          <div class="well-editor-gpt-grid">
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorOilDiffPct">Oil Diff %</label>
              <input id="wellEditorOilDiffPct" type="number" step="0.001" inputmode="decimal" data-field="OIL_DIFF_PCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorOilDiffAmt">Oil Diff $/BBL</label>
              <input id="wellEditorOilDiffAmt" type="number" step="0.01" inputmode="decimal" data-field="OIL_DIFF_AMT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorGasDiffPct">Gas Diff %</label>
              <input id="wellEditorGasDiffPct" type="number" step="0.001" inputmode="decimal" data-field="GAS_DIFF_PCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorGasDiffAmt">Gas Diff $/MCF</label>
              <input id="wellEditorGasDiffAmt" type="number" step="0.01" inputmode="decimal" data-field="GAS_DIFF_AMT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNglDiffPct">NGL Diff %</label>
              <input id="wellEditorNglDiffPct" type="number" step="0.001" inputmode="decimal" data-field="NGL_DIFF_PCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNglDiffAmt">NGL Diff $/BBL</label>
              <input id="wellEditorNglDiffAmt" type="number" step="0.01" inputmode="decimal" data-field="NGL_DIFF_AMT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNglYield">NGL Yield (BBL/MMCF)</label>
              <input id="wellEditorNglYield" type="number" step="0.01" inputmode="decimal" data-field="NGL_YIELD">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorGasShrink">Gas Shrink</label>
              <input id="wellEditorGasShrink" type="number" step="0.001" inputmode="decimal" data-field="GAS_SHRINK">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorOilGpt">Oil GPT $/BBL</label>
              <input id="wellEditorOilGpt" type="number" step="0.01" inputmode="decimal" data-field="OIL_GPT_DEDUCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorGasGpt">Gas GPT $/MCF</label>
              <input id="wellEditorGasGpt" type="number" step="0.01" inputmode="decimal" data-field="GAS_GPT_DEDUCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNglGpt">NGL GPT $/BBL</label>
              <input id="wellEditorNglGpt" type="number" step="0.01" inputmode="decimal" data-field="NGL_GPT_DEDUCT">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorOilTax">Oil Tax</label>
              <input id="wellEditorOilTax" type="number" step="0.001" inputmode="decimal" data-field="OIL_TAX">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorGasTax">Gas Tax</label>
              <input id="wellEditorGasTax" type="number" step="0.001" inputmode="decimal" data-field="GAS_TAX">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNglTax">NGL Tax</label>
              <input id="wellEditorNglTax" type="number" step="0.001" inputmode="decimal" data-field="NGL_TAX">
            </div>
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorAdValTax">Ad Valorem Tax</label>
              <input id="wellEditorAdValTax" type="number" step="0.001" inputmode="decimal" data-field="AD_VAL_TAX">
            </div>
          </div>
          <div class="well-editor-gpt-actions">
            <div class="well-editor-field">
              <label class="well-editor-field__label" for="wellEditorNewScenarioName">New GPT Scenario</label>
              <input id="wellEditorNewScenarioName" type="text" placeholder="Enter new scenario name">
            </div>
            <div class="well-editor-gpt-buttons">
              <button type="button" id="wellEditorSaveScenario" class="well-editor-secondary">Save GPT Scenario</button>
              <button type="button" id="wellEditorSaveGptToWell" class="well-editor-secondary">Save GPT to Well</button>
            </div>
          </div>
        </div>
        <div id="wellEditorStatus" class="well-editor-status" role="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <div id="wellFastEditModal" class="fast-edit-modal" aria-hidden="true">
    <div class="fast-edit-modal__overlay" data-fast-edit-close></div>
    <div class="fast-edit-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="fastEditTitle">
      <header class="fast-edit-modal__header">
        <div class="fast-edit-modal__intro">
          <p class="fast-edit-modal__eyebrow">Well Forecast Fast Edit</p>
          <h2 id="fastEditTitle" class="fast-edit-modal__title sr-only">FAST EDIT</h2>
          <div class="fast-edit-modal__well-nav">
            <button type="button" id="fastEditPrevWell" class="fast-edit-nav-button" aria-label="Previous well">
              <span aria-hidden="true">←</span>
            </button>
            <select id="fastEditWellSelect" class="fast-edit-well-select" aria-label="Select well"></select>
            <button type="button" id="fastEditNextWell" class="fast-edit-nav-button" aria-label="Next well">
              <span aria-hidden="true">→</span>
            </button>
          </div>
        </div>
        <div class="fast-edit-modal__controls">
          <button type="button" id="fastEditSaveApprove" class="fast-edit-save-approve">Save &amp; Approve</button>
          <button type="button" id="fastEditModeToggle" class="fast-edit-toggle">Switch to Oil</button>
          <button type="button" id="fastEditAutoFit" class="fast-edit-autofit">Auto-Fit</button>
          <button type="button" id="fastEditReset" class="fast-edit-reset">Reset</button>
          <div class="fast-edit-decline-toggle">
            <span id="fastEditDeclineLabel" class="fast-edit-decline-label">Exponential</span>
            <label class="fast-edit-switch">
              <input type="checkbox" id="fastEditDeclineToggle" class="fast-edit-switch__input">
              <span class="fast-edit-switch__slider" aria-hidden="true"></span>
            </label>
          </div>
          <button type="button" class="fast-edit-modal__close" data-fast-edit-close aria-label="Close fast edit view">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </header>
      <div class="fast-edit-modal__content">
        <div class="fast-edit-modal__chart">
          <div id="wellFastEditChart"></div>
          <div id="fastEditPadLeft" class="fast-edit-pad fast-edit-pad--left" aria-hidden="true">
            <span class="fast-edit-pad__label">↕ qᵢ<br>↔ start date</span>
          </div>
          <div id="fastEditPadRight" class="fast-edit-pad fast-edit-pad--right" aria-hidden="true">
            <span class="fast-edit-pad__label">↕ Dᵢ<br>↔ b</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'mapapp/js/main.js' %}?v=2025-08-25b"></script>
  <script src="{% static 'mapapp/js/well_explorer.js' %}?v=2025-08-25c"></script>
{% endblock %}
